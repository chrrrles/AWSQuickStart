{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Aviatrix Systems - Master Stack - Creates the necessary policies, roles, security group and launches Aviatrix Controller instance",
  "Metadata" :
  {
    "AWS::CloudFormation::Interface" :
    {
      "ParameterGroups" :
      [
        { "Label" : { "default" : "Network Configuration" }, "Parameters" : [ "VPCParam", "SubnetParam" ] },
        { "Label" : { "default":"Amazon EC2 Configuration" }, "Parameters" : [ "KeyNameParam" ] },
        { "Label" : { "default" : "Parent AWS AccountId" }, "Parameters" : [ "ParentAccountID"] }
      ],
      "ParameterLabels" :
      {
         "VPCParam" : { "default" : "Which VPC should the Aviatrix Controller be deployed to?" },
         "SubnetParam" : { "default" : "Which subnet within that VPC?" },
         "KeyNameParam" : { "default" : "Which keypair will be used?" },
         "ParentAccountID" : { "default" : "Parent AWS account? (optional)" }
      }
    }
  },
  "Parameters":
  {
    "VPCParam": { "Type": "AWS::EC2::VPC::Id", "Description": "Select Your VPC" },
    "SubnetParam": { "Type": "AWS::EC2::Subnet::Id", "Description": "Select Subnet" },
    "KeyNameParam": { "Type": "AWS::EC2::KeyPair::KeyName", "Description": "Select your Keypair" },
    "ParentAccountID": { "Type": "String", "Description": "Parent AWS AccountId" }
  },
  "Resources" :
  {
    "AviatrixIAMRolesStack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
          "TemplateURL": {
              "Fn::Sub": "https://s3-us-west-1.amazonaws.com/cf-templates-qgn1s8seb2ep-us-west-1/2017256e6P-aviatrix-aws-quickstart-iamroles.json"
          },
          "Parameters": {
              "ParentAccountID": {
                  "Ref": "ParentAccountID"
              }
          }
      }
    },
    "AviatrixControllerStack": {
        "DependsOn": "AviatrixIAMRolesStack",
        "Type": "AWS::CloudFormation::Stack",
        "Properties": {
          "TemplateURL": {
            "Fn::Sub": "https://s3-us-west-1.amazonaws.com/cf-templates-qgn1s8seb2ep-us-west-1/2017256ufx-aviatrix-aws-quickstart-controller.json"
          },
          "Parameters": {
              "VPCParam" : {
                "Ref": "VPCParam",
              },
              "SubnetParam" : {
                "Ref": "SubnetParam",
              },
              "KeyNameParam" : {
                "Ref": "KeyNameParam",
              },
              "AviatrixInstanceProfile" : {
                "Fn::GetAtt": [
                    "AviatrixIAMRolesStack",
                    "Outputs.AviatrixInstanceProfile"
                ]
              }
          }
        }
    }
  },
  "Outputs" :
  {
    "AccountId" : { "Description": "Amazon Account ID", "Value" : { "Fn::GetAtt" : [ "AviatrixIAMRolesStack", "Outputs.AccountId" ] } },
    "AviatrixRoleAppARN" : { "Description": "AviatrixRoleApp ARN", "Value" : { "Fn::GetAtt" : [ "AviatrixIAMRolesStack", "Outputs.AviatrixRoleAppARN" ] } },
    "AviatrixRoleEC2ARN" : { "Description": "AviatrixRoleEC2 ARN", "Value" : { "Fn::GetAtt" : [ "AviatrixIAMRolesStack", "Outputs.AviatrixRoleEC2ARN" ] } },
    "AviatrixControllerEIP" : { "Description": "AviatrixController External IP", "Value" : { "Fn::GetAtt" : [ "AviatrixControllerStack", "Outputs.AviatrixControllerEIP" ] } },
    "AviatrixControllerPrivateIP" : { "Description": "AviatrixController Private IP", "Value" : { "Fn::GetAtt" : [ "AviatrixControllerStack", "Outputs.AviatrixControllerPrivateIP" ] } }
  }
}
