{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Aviatrix Systems - Launches Aviatrix Controller instance",
  "Metadata" :
  {
    "AWS::CloudFormation::Interface" :
    {
      "ParameterGroups" :
      [
        { "Label" : { "default" : "Network Configuration" }, "Parameters" : [ "VPCParam", "SubnetParam" ] },
        { "Label" : { "default" : "Amazon EC2 Configuration" }, "Parameters" : [ "KeyNameParam" ] },
        { "Label" : { "default" : "Aviatrix Roles Configuration"}, "Parameters" : [ "AviatrixInstanceProfile" ] }
      ],
      "ParameterLabels" :
      {
         "VPCParam" : { "default" : "Which VPC should the Aviatrix Controller be deployed to?" },
         "SubnetParam" : { "default" : "Which subnet within that VPC?" },
         "KeyNameParam" : { "default" : "Which keypair will be used?" },
         "AviatrixInstanceProfile" : { "default": "If created by CF use: aviatrix-role-ec2" }
      }
    }
  },
  "Parameters":
  {
    "VPCParam": { "Type": "AWS::EC2::VPC::Id", "Description": "Select Your VPC" },
      "SubnetParam": { "Type": "AWS::EC2::Subnet::Id", "Description": "Select Subnet" },
      "KeyNameParam": { "Type": "AWS::EC2::KeyPair::KeyName", "Description": "Select your Keypair" },
      "AviatrixInstanceProfile" : { "Type":  "String", "Description": "Aviatrix Instance Profile", "Default": "aviatrix-role-ec2" }
  },
  "Rules": {
      "KeyPairsNotEmpty": {
          "Assertions": [
              {
                  "Assert": {
                      "Fn::Not": [
                          {
                              "Fn::EachMemberEquals": [
                                  {
                                      "Fn::RefAll": "AWS::EC2::KeyPair::KeyName"
                                  },
                                  ""
                              ]
                          }
                      ]
                  },
                  "AssertDescription": "All key pair parameters must not be empty"
              }
          ]
      },
      "SubnetsInVPC": {
          "Assertions": [
              {
                  "Assert": {
                      "Fn::EachMemberIn": [
                          {
                              "Fn::ValueOfAll": [
                                  "AWS::EC2::Subnet::Id",
                                  "VpcId"
                              ]
                          },
                          {
                              "Fn::RefAll": "AWS::EC2::VPC::Id"
                          }
                      ]
                  },
                  "AssertDescription": "All subnets must in the VPC"
              }
          ]
      }
  },
  "Mappings" :
  {
    "RegionMap" :
    {
      "us-east-1" : { "Name" : "ami-1f28d965" },
      "us-east-2" : { "Name" : "ami-85466be0" },
      "us-west-1" : { "Name" : "ami-b49faed4" },
      "us-west-2" : { "Name" : "ami-3a47b942" },
      "ca-central-1" : { "Name" : "ami-9372cbf7" },
      "eu-central-1" : { "Name" : "ami-5e249431" },
      "eu-west-1" : { "Name" : "ami-760cc40f" },
      "eu-west-2" : { "Name" : "ami-ffb8ab9b" },
      "ap-south-1" : { "Name" : "ami-c33b7aac" },
      "ap-northeast-1" : { "Name" : "ami-23a47145" },
      "ap-northeast-2" : { "Name" : "ami-f8a07a96" },
      "ap-southeast-1" : { "Name" : "ami-beb1c2dd" },
      "ap-southeast-2" : { "Name" : "ami-fc16f79e" },
      "sa-east-1" : { "Name" : "ami-70463a1c" }
    }
  },
  "Resources" :
  {
    "AviatrixController" :
    {
      "Type" : "AWS::EC2::Instance",
      "Properties" :
      {
        "ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "Name" ]},
        "KeyName" : { "Ref": "KeyNameParam" },
        "InstanceType": "t2.large",
        "IamInstanceProfile" : {"Ref":  "AviatrixInstanceProfile" },
        "NetworkInterfaces":
        [ {
            "DeviceIndex": "0",
            "GroupSet": [{ "Ref" : "AviatrixSG" }],
            "SubnetId": { "Ref" : "SubnetParam" }
        } ],
        "Tags":
        [
          { "Key": "Name", "Value": "Aviatrix Controller" },
          { "Key": "Project", "Value": "Aviatrix" },
          { "Key": "CreatedUsing", "Value": "Aviatrix Quickstart" }
        ]
      }
    },
    "AviatrixEIP":
    {
      "Type": "AWS::EC2::EIP",
      "Properties" : {
        "InstanceId" : {"Ref":  "AviatrixController" }
      }
    },
    "AviatrixSG":
    {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties":
      {
        "GroupName": "AviatrixControllerSG",
        "GroupDescription": "Aviatrix - Allow HTTPS to Controller",
        "VpcId": { "Ref": "VPCParam" },
        "SecurityGroupIngress":
        [ {
          "IpProtocol": "tcp",
          "CidrIp": "0.0.0.0/0",
          "FromPort": "443",
          "ToPort": "443"
        } ],
        "Tags":
        [
          { "Key": "Name", "Value": "Aviatrix Security Group" },
          { "Key": "Project", "Value": "Aviatrix" },
          { "Key": "CreatedUsing", "Value": "Aviatrix Quickstart" }
        ]
      }
    }
  },
  "Outputs" :
  {
    "AccountId" : { "Description": "Amazon Account ID", "Value" : { "Ref" : "AWS::AccountId" } },
    "AviatrixControllerEIP" : { "Description": "AviatrixController External IP", "Value" : { "Fn::GetAtt" : [ "AviatrixController" , "PublicIp" ] } },
    "AviatrixControllerPrivateIP" : { "Description": "AviatrixController Private IP", "Value" : { "Fn::GetAtt" : [ "AviatrixController" , "PrivateIp" ] } }
  }
}
